# C4 Model Architecture Diagrams

This document provides multiple levels of architectural diagrams using the C4 model (Context, Containers, Components, Code) for the CRM + AI system.

## About C4 Model

The C4 model provides a hierarchical way to visualize software architecture at different levels of abstraction:
1. **Level 1 (Context)**: How the system fits into the world
2. **Level 2 (Containers)**: High-level technology choices
3. **Level 3 (Components)**: Internal structure of containers
4. **Level 4 (Code)**: Implementation details (classes, functions)

## Table of Contents
1. [Level 1: System Context](#level-1-system-context)
2. [Level 2: Container Diagram](#level-2-container-diagram)
3. [Level 3: Component Diagram](#level-3-component-diagram)
4. [Additional Diagrams](#additional-diagrams)
   - [Dynamic Diagram](#dynamic-diagram-appointment-booking-flow)
   - [Deployment Diagram](#deployment-diagram)
   - [Security Architecture](#security-architecture)

---

## Level 1: System Context

Shows how the CRM system fits into the world around it - who uses it and what other systems it integrates with.

```mermaid
C4Context
    title System Context Diagram for CRM System

    Person(staff, "Staff Member", "Medical staff who manage appointments and patient records")
    Person(patient, "Patient/Contact", "Individuals who book and attend appointments")
    Person(admin, "System Admin", "Manages staff accounts and system configuration")

    System(crm, "CRM System", "Manages contacts, appointments, staff scheduling, and automated reminders")

    System_Ext(email, "Email System", "SendGrid/AWS SES for sending appointment reminders and notifications")
    System_Ext(sms, "SMS Gateway", "Twilio for sending text message reminders")
    System_Ext(calendar, "Calendar Systems", "Google Calendar, Outlook via iCal export")

    Rel(staff, crm, "Manages appointments, views schedules", "HTTPS/JSON")
    Rel(patient, crm, "Books appointments, views history", "HTTPS/JSON")
    Rel(admin, crm, "Manages staff, configures system", "HTTPS/JSON")

    Rel(crm, email, "Sends appointment reminders", "SMTP/API")
    Rel(crm, sms, "Sends SMS reminders", "REST API")
    Rel(crm, calendar, "Exports schedules", "iCal/ICS")

    UpdateLayoutConfig($c4ShapeInRow="3", $c4BoundaryInRow="1")
```

**Key Elements:**
- **Staff Members**: Create/manage appointments, view schedules, manage availability
- **Patients/Contacts**: Book appointments, receive reminders
- **System Admins**: Configure system, manage staff accounts
- **External Systems**: Email, SMS, Calendar integrations

---

## Level 2: Container Diagram

Shows the high-level technology choices and how containers communicate.

```mermaid
C4Container
    title Container Diagram for CRM System

    Person(user, "User", "Staff, Patients, Admins")

    Container_Boundary(crm_boundary, "CRM System") {
        Container(web_app, "Web Application", "FastAPI", "Provides REST API for CRM functionality, handles HTTP requests")
        Container(scheduler, "Background Scheduler", "APScheduler", "Processes scheduled tasks like sending reminders")
        ContainerDb(database, "Database", "PostgreSQL/SQLite", "Stores contacts, appointments, staff, availability, reminders")
    }

    System_Ext(email_service, "Email Service", "SendGrid/SES")
    System_Ext(sms_service, "SMS Service", "Twilio")
    System_Ext(calendar_client, "Calendar Client", "Google/Outlook")

    Rel(user, web_app, "Uses", "HTTPS/JSON")
    Rel(web_app, database, "Reads/Writes", "SQLAlchemy ORM")
    Rel(scheduler, database, "Reads pending reminders", "SQLAlchemy ORM")
    Rel(scheduler, email_service, "Sends emails", "SMTP/REST")
    Rel(scheduler, sms_service, "Sends SMS", "REST API")
    Rel(web_app, calendar_client, "Exports iCal", "HTTP/ICS file")

    UpdateLayoutConfig($c4ShapeInRow="2", $c4BoundaryInRow="1")
```

**Containers:**
1. **Web Application (FastAPI)**: REST API, business logic, request handling
2. **Background Scheduler (APScheduler)**: Automated reminder processing
3. **Database (PostgreSQL/SQLite)**: Persistent storage

**Technology Choices:**
- **FastAPI**: Async Python web framework
- **SQLAlchemy**: ORM for database access
- **Alembic**: Database migrations
- **Pydantic**: Data validation
- **APScheduler**: Background job scheduling

---

## Level 3: Component Diagram

Shows the components inside the Web Application container.

```mermaid
C4Component
    title Component Diagram for Web Application Container

    Container_Boundary(web_app, "Web Application (FastAPI)") {
        Component(router_contacts, "Contact Router", "FastAPI Router", "Handles contact CRUD operations")
        Component(router_staff, "Staff Router", "FastAPI Router", "Handles staff management")
        Component(router_appointments, "Appointment Router", "FastAPI Router", "Handles appointment booking and management")
        Component(router_availability, "Availability Router", "FastAPI Router", "Manages staff availability schedules")
        Component(router_calendar, "Calendar Router", "FastAPI Router", "Exports calendars as iCal")

        Component(service_scheduling, "Scheduling Service", "Python Module", "Conflict detection, availability checking")
        Component(service_slots, "Slot Calculator", "Python Module", "Calculates available time slots")
        Component(service_ical, "iCal Service", "Python Module", "Generates ICS calendar files")
        Component(service_reminders, "Reminder Manager", "Python Module", "Creates and manages appointment reminders")

        Component(schemas, "Pydantic Schemas", "Data Validation", "Request/response validation and serialization")
        Component(models, "SQLAlchemy Models", "ORM Entities", "Database entities and business rules")
        Component(database_session, "Database Session", "Session Manager", "Manages database connections and transactions")
    }

    ContainerDb(database, "Database", "PostgreSQL/SQLite")
    Person(user, "User")

    Rel(user, router_contacts, "CRUD contacts", "HTTPS/JSON")
    Rel(user, router_staff, "Manage staff", "HTTPS/JSON")
    Rel(user, router_appointments, "Book/manage appointments", "HTTPS/JSON")
    Rel(user, router_availability, "Set availability", "HTTPS/JSON")
    Rel(user, router_calendar, "Export calendar", "HTTPS/ICS")

    Rel(router_appointments, service_scheduling, "Check conflicts")
    Rel(router_appointments, service_reminders, "Create reminders")
    Rel(router_availability, service_slots, "Calculate slots")
    Rel(router_calendar, service_ical, "Generate ICS")

    Rel(router_contacts, schemas, "Validate data")
    Rel(router_staff, schemas, "Validate data")
    Rel(router_appointments, schemas, "Validate data")

    Rel(router_contacts, models, "Use entities")
    Rel(router_staff, models, "Use entities")
    Rel(router_appointments, models, "Use entities")

    Rel(models, database_session, "Use")
    Rel(database_session, database, "Read/Write", "SQL")

    UpdateLayoutConfig($c4ShapeInRow="3", $c4BoundaryInRow="1")
```

**Component Groups:**

### Routers (Controllers - Layer 3)
- **Contact Router**: `/api/v1/contacts/*` - Contact management
- **Staff Router**: `/api/v1/staff/*` - Staff CRUD operations
- **Appointment Router**: `/api/v1/appointments/*` - Appointment booking
- **Availability Router**: `/api/v1/staff/{id}/availability/*` - Schedule management
- **Calendar Router**: `/api/v1/calendar/*` - iCal exports

### Services (Use Cases - Layer 2)
- **Scheduling Service**: Conflict detection, availability validation
- **Slot Calculator**: Available time slot computation
- **iCal Service**: Calendar file generation
- **Reminder Manager**: Reminder creation and scheduling

### Data Layer (Layer 1 & 3)
- **Pydantic Schemas**: Input/output validation, DTOs
- **SQLAlchemy Models**: Entities (Contact, Staff, Appointment, etc.)
- **Database Session**: Connection pooling, transaction management

---

## Level 4: Code Diagram

### Appointment Booking Flow

```mermaid
C4Component
    title Code-Level Diagram: Appointment Booking Flow

    Container_Boundary(appointment_flow, "Appointment Creation Flow") {
        Component(endpoint, "POST /appointments/", "Router Endpoint", "HTTP entry point")
        Component(schema_create, "AppointmentCreate", "Pydantic Schema", "Validates input data")
        Component(schema_response, "AppointmentResponse", "Pydantic Schema", "Formats output")

        Component(conflict_check, "check_staff_conflict()", "Service Function", "Queries overlapping appointments")
        Component(availability_check, "check_staff_availability()", "Service Function", "Validates against staff schedule")

        Component(appointment_entity, "Appointment", "SQLAlchemy Model", "Business entity with status enum")
        Component(reminder_create, "create_default_reminders()", "Service Function", "Auto-creates email/SMS reminders")

        Component(db_session, "AsyncSession", "SQLAlchemy Session", "Database transaction")
    }

    ContainerDb(db, "Database")

    Rel(endpoint, schema_create, "1. Validate input")
    Rel(endpoint, conflict_check, "2. Check conflicts")
    Rel(conflict_check, db_session, "Query appointments")
    Rel(endpoint, availability_check, "3. Check availability")
    Rel(availability_check, db_session, "Query availability")
    Rel(endpoint, appointment_entity, "4. Create entity")
    Rel(appointment_entity, db_session, "5. Insert")
    Rel(db_session, db, "SQL INSERT")
    Rel(endpoint, reminder_create, "6. Create reminders")
    Rel(reminder_create, db_session, "Insert reminders")
    Rel(endpoint, schema_response, "7. Format response")

    UpdateLayoutConfig($c4ShapeInRow="2", $c4BoundaryInRow="1")
```

**Execution Flow:**
1. Validate input with `AppointmentCreate` schema
2. Check for conflicting appointments (business rule)
3. Verify staff availability for requested time
4. Create `Appointment` entity with calculated end_time
5. Persist to database
6. Auto-create email/SMS reminders
7. Return validated response via `AppointmentResponse`

---

## Scheduling System Components Detail

```mermaid
C4Component
    title Scheduling & Calendar System Components

    Container_Boundary(scheduling, "Scheduling System") {
        Component(models_appt, "Appointment Model", "Entity", "status, start_time, end_time, duration")
        Component(models_staff, "Staff Model", "Entity", "role, is_active, relationships")
        Component(models_avail, "StaffAvailability Model", "Entity", "working_hours, time_off, overrides")
        Component(models_reminder, "Reminder Model", "Entity", "type, status, scheduled_for")

        Component(svc_conflict, "Conflict Detection", "Business Logic", "Range overlap queries")
        Component(svc_slots, "Slot Calculation", "Algorithm", "Available time computation")
        Component(svc_ical, "iCal Generator", "Formatter", "RFC 5545 compliance")
        Component(svc_reminder_mgr, "Reminder Creator", "Business Logic", "24h email, 2h SMS")
        Component(svc_reminder_scheduler, "Reminder Processor", "Background Job", "APScheduler task")
    }

    System_Ext(email, "Email Gateway")
    System_Ext(sms, "SMS Gateway")

    Rel(models_appt, models_staff, "belongs to")
    Rel(models_staff, models_avail, "has many")
    Rel(models_appt, models_reminder, "has many")

    Rel(svc_conflict, models_appt, "Queries")
    Rel(svc_slots, models_avail, "Queries")
    Rel(svc_slots, models_appt, "Queries")
    Rel(svc_ical, models_appt, "Reads")
    Rel(svc_reminder_mgr, models_reminder, "Creates")
    Rel(svc_reminder_scheduler, models_reminder, "Processes")
    Rel(svc_reminder_scheduler, email, "Sends")
    Rel(svc_reminder_scheduler, sms, "Sends")

    UpdateLayoutConfig($c4ShapeInRow="3", $c4BoundaryInRow="1")
```

---

## Data Flow: Available Slot Calculation

```mermaid
C4Dynamic
    title Dynamic Diagram: Calculate Available Slots

    Person(user, "Staff Member")
    Container(api, "FastAPI App")
    Container(slot_service, "Slot Calculator Service")
    ContainerDb(db, "Database")

    Rel(user, api, "GET /staff/1/availability/slots?date=2025-12-15&duration=60", "HTTPS")
    Rel(api, slot_service, "calculate_available_slots(staff_id, date, duration)")
    Rel(slot_service, db, "1. Get working hours for date")
    Rel(db, slot_service, "Mon 9:00-17:00")
    Rel(slot_service, db, "2. Get time-off periods")
    Rel(db, slot_service, "Lunch 12:00-13:00")
    Rel(slot_service, db, "3. Get existing appointments")
    Rel(db, slot_service, "10:00-11:00, 14:00-15:00")
    Rel(slot_service, slot_service, "4. Calculate: 9:00-17:00 - lunch - appointments")
    Rel(slot_service, slot_service, "5. Split into 60-min slots")
    Rel(slot_service, api, "Available: 9:00, 11:00, 15:00, 16:00")
    Rel(api, user, "JSON array of time slots")

    UpdateLayoutConfig($c4ShapeInRow="1", $c4BoundaryInRow="1")
```

**Algorithm Steps:**
1. Retrieve working hours for requested date
2. Remove time-off periods (vacation, breaks)
3. Remove existing appointments (booked slots)
4. Calculate remaining time windows
5. Split windows into slots of requested duration
6. Return sorted list of available start times

---

## Deployment Diagram

```mermaid
C4Deployment
    title Deployment Diagram for CRM System

    Deployment_Node(dev, "Development Environment", "Local Machine") {
        Deployment_Node(dev_container, "Docker Container", "Optional") {
            Container(dev_app, "FastAPI App", "uvicorn")
            ContainerDb(dev_db, "SQLite", "File-based DB")
        }
    }

    Deployment_Node(prod, "Production Environment", "Cloud Platform") {
        Deployment_Node(app_server, "Application Server", "VM/Container") {
            Container(prod_app, "FastAPI App", "gunicorn + uvicorn")
            Container(scheduler_prod, "APScheduler", "Background worker")
        }
        Deployment_Node(db_server, "Database Server", "Managed Service") {
            ContainerDb(prod_db, "PostgreSQL", "Primary + Replica")
        }
        Deployment_Node(cache, "Cache Layer", "Redis/Memcached") {
            Container(redis, "Session Cache", "Redis")
        }
    }

    Deployment_Node(cdn, "Static Assets", "CDN") {
        Container(static, "Static Files", "CSS, JS, Images")
    }

    Rel(dev_app, dev_db, "Local development", "SQLAlchemy")
    Rel(prod_app, prod_db, "Production data", "Connection pool")
    Rel(prod_app, redis, "Session storage", "Redis protocol")
    Rel(scheduler_prod, prod_db, "Read reminders", "SQLAlchemy")

    UpdateLayoutConfig($c4ShapeInRow="2", $c4BoundaryInRow="1")
```

---

## Security Boundaries

```mermaid
C4Container
    title Security Boundary Diagram

    Person(public_user, "Public User", "Unauthenticated")
    Person(auth_user, "Authenticated User", "JWT token")
    Person(admin, "Admin User", "Role: admin")

    System_Boundary(dmz, "DMZ - Public Access") {
        Container(api_gateway, "API Gateway", "Rate limiting, SSL termination")
        Container(auth_service, "Auth Service", "JWT validation, OAuth")
    }

    System_Boundary(app_zone, "Application Zone - Private") {
        Container(crm_app, "CRM Application", "Business logic, requires auth")
        ContainerDb(app_db, "Application Database", "Encrypted at rest")
    }

    System_Boundary(internal, "Internal Zone - Admin Only") {
        Container(admin_panel, "Admin Panel", "System configuration")
        Container(monitoring, "Monitoring", "Logs, metrics, alerts")
    }

    Rel(public_user, api_gateway, "HTTPS only")
    Rel(api_gateway, auth_service, "Validate credentials")
    Rel(auth_user, api_gateway, "Bearer token", "HTTPS")
    Rel(api_gateway, crm_app, "Authorized requests")
    Rel(crm_app, app_db, "Encrypted connection", "TLS")
    Rel(admin, admin_panel, "Admin credentials", "HTTPS + MFA")
    Rel(admin_panel, monitoring, "Internal network only")

    UpdateLayoutConfig($c4ShapeInRow="2", $c4BoundaryInRow="1")
```

---

## Summary

### C4 Model Levels Overview

| Level | Diagram Type   | Audience                         | Purpose                          |
|-------|----------------|----------------------------------|----------------------------------|
| 1     | System Context | Non-technical stakeholders       | How the system fits in the world |
| 2     | Container      | Technical leadership, architects | High-level technology choices    |
| 3     | Component      | Developers, architects           | Internal structure of containers |
| 4     | Code           | Developers                       | Implementation details, classes  |

### Key Architectural Patterns

1. **Clean Architecture**: Entities → Use Cases → Interface Adapters → Frameworks
2. **Repository Pattern**: Database access abstraction (SQLAlchemy ORM)
3. **Dependency Injection**: FastAPI's `Depends()` for session management
4. **DTO Pattern**: Pydantic schemas for data validation/serialization
5. **Background Jobs**: APScheduler for async task processing
6. **API Gateway Pattern**: Single entry point with routing

### Technology Stack Summary

| Layer         | Technology        | Purpose                      |
|---------------|-------------------|------------------------------|
| API Framework | FastAPI           | Async REST API, OpenAPI docs |
| ORM           | SQLAlchemy 2.0    | Async database access        |
| Validation    | Pydantic 2.x      | Schema validation            |
| Database      | PostgreSQL/SQLite | Persistent storage           |
| Migration     | Alembic           | Schema version control       |
| Scheduling    | APScheduler       | Background jobs              |
| Calendar      | iCalendar         | RFC 5545 exports             |
| Testing       | pytest-asyncio    | Async test framework         |

---

## Related Documentation

- [Clean Architecture Details](./architecture.md) - Comprehensive architecture documentation
- [Big Picture Overview](./BIG_PICTURE.md) - High-level MVP vision and module roadmap
- [README](../README.md) - Project overview and setup instructions

**Document Version:** 1.1
**Last Updated:** 2025-12-14
**Generated by:** Claude Code

**External References:**
- [C4 Model](https://c4model.com/)
- [Mermaid C4 Diagrams](https://mermaid.js.org/syntax/c4.html)
